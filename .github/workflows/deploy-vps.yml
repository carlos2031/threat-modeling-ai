# Deploy Threat Modeling AI no VPS PESSOAL (69.62.98.94) — NÃO usar ExpenseIQ/KPI.
# Secrets: VPS_SSH_PRIVATE_KEY (chave para root@69.62.98.94) ou VPS_SSH_PASSWORD.

name: Deploy to VPS (personal)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to personal VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 69.62.98.94
          username: root
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          password: ${{ secrets.VPS_SSH_PASSWORD }}
          script: |
            set -e
            export PATH="/usr/local/bin:$PATH"
            cd /opt/projects/threat-modeling-ai || { mkdir -p /opt/projects && cd /opt/projects && git clone https://github.com/LucasBiason/threat-modeling-ai.git && cd threat-modeling-ai; }
            git fetch origin main
            git reset --hard origin/main
            if [ -f configs/.env.prod ]; then
              docker compose -f docker-compose.prod.yml --env-file configs/.env.prod up -d --build
            else
              echo "AVISO: configs/.env.prod nao encontrado. Crie o arquivo no servidor e rode o workflow de novo."
              exit 1
            fi
            docker compose -f docker-compose.prod.yml ps
